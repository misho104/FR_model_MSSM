: ${MATH:=WolframKernel}

: ${FR_DIR:="$PWD/FeynRules"}
: ${FR_FILE:="MSSM.fr"}
: ${FR_MODEL_NAME:="MSSM"}
: ${MY_MODEL_NAME:="MSSM"}
: ${TMP_FILE:="MSSM.tmp"}
: ${TMP_ZERO:="ZeroValues.rst"}

INIT="
  SetDirectory[\"$PWD\"];
  \$FeynRulesPath=\"$FR_DIR\";
  FR\$Parallel = False;
  <<FeynRules\`;
  LoadModel[\"$FR_FILE\"];
"

ask_yn () {
  echo $1 [y/N]
  read ANSWER
  case $ANSWER in
  [Yy]* ) return 1;;
  * ) return 0;;
  esac
}

generate_lagrangian_file(){
  if [ -f $TMP_FILE ]; then
    ask_yn "Temporary output of Lagrangian exists. Regenerate it?"
    if [ $? == 1 ]; then
      rm -rf $TMP_FILE
    fi
  fi
  if [ ! -f $TMP_FILE ]; then
    $MATH <<_EOC_
$INIT
lagr=Lag;
(*
	WriteRestrictionFile[];
	LoadRestriction["${TMP_ZERO}"];
  DeleteFile["${TMP_ZERO}"];
*)
LagNoGhNG=lagr/.{ghG[__]->0, ghGbar[__]->0,ghWp->0,ghWpbar->0,ghWmbar->0,ghWm->0,ghZ->0,ghZbar->0,ghA->0,ghAbar->0, G0->0,GP->0,GPbar->0};
{Definition[lagr],Definition[LagNoGhNG]}>>$TMP_FILE
_EOC_
  fi
}

generate_ufo(){
  local POINT=$1
  $MATH <<_EOC_
$INIT
<<${TMP_FILE};
ReadLHAFile[Input->"${POINT}.dat"];
WriteRestrictionFile[];LoadRestriction["${TMP_ZERO}"];DeleteFile["${TMP_ZERO}"];
WriteUFO[lagr, Exclude4Scalars->False];
_EOC_
  rm -rf ${MY_MODEL_NAME}_${POINT}_UFO
  rm -rf ${TMP_ZERO}
  mv ${FR_MODEL_NAME}_UFO ${MY_MODEL_NAME}_${POINT}_UFO
}

generate_fa(){
  local POINT=$1
  $MATH <<_EOC_
$INIT
<<${TMP_FILE};
ReadLHAFile[Input->"${POINT}.dat"];
WriteRestrictionFile[];LoadRestriction["${TMP_ZERO}"];DeleteFile["${TMP_ZERO}"];
WriteFeynArtsOutput[lagr, Exclude4Scalars->False];
_EOC_
  rm -rf ${MY_MODEL_NAME}_${POINT}_FA
  rm -rf ${TMP_ZERO}
  mv ${FR_MODEL_NAME}_FA ${MY_MODEL_NAME}_${POINT}_FA
}

generate_whizard(){
  local POINT=$1
  local VERSION=$2
  local VERSION_NUM=`echo $VERSION | sed 's/\.//g'`
  $MATH <<_EOC_
$INIT
<<${TMP_FILE};
ReadLHAFile[Input->"${POINT}_wo.dat"];
WriteRestrictionFile[];LoadRestriction["${TMP_ZERO}"];DeleteFile["${TMP_ZERO}"];
WriteWOOutput[lagr, WOGauge->WOUnitarity, WOMaxCouplingsPerFile->5000, WOVerbose->True, WOWhizardVersion->"${VERSION}"];
_EOC_
  rm -rf ${MY_MODEL_NAME}_${POINT}_WO${VERSION_NUM}
  rm -rf ${TMP_ZERO}
  mv fr_mssm-WO ${MY_MODEL_NAME}_${POINT}_WO${VERSION_NUM}
}
